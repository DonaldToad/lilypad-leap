"use client";

import dynamic from "next/dynamic";
import TopNav from "../components/TopNav";
import { CHAIN_LIST, PRIMARY_CHAIN } from "../lib/chains";

import { useEffect, useMemo, useState } from "react";
import { useAccount, useConnect, useWalletClient } from "wagmi";
import { mainnet, linea, base, arbitrum, optimism } from "wagmi/chains";

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import {
  MAINNET_RELAY_API,
  convertViemChainToRelayChain,
  createClient,
} from "@relayprotocol/relay-sdk";

// Relay UI must be client-only
const RelayKitProviderNoSSR = dynamic(
  () => import("@relayprotocol/relay-kit-ui").then((m) => m.RelayKitProvider),
  { ssr: false }
);
const SwapWidgetNoSSR = dynamic(
  () => import("@relayprotocol/relay-kit-ui").then((m) => m.SwapWidget),
  { ssr: false }
);

function ChainIcon({ chainKey, alt }: { chainKey: string; alt: string }) {
  const src = `/chains/${chainKey}.png`;
  return (
    <img
      src={src}
      alt={alt}
      width={28}
      height={28}
      className="h-7 w-7 rounded-lg ring-1 ring-neutral-800"
      loading="lazy"
      decoding="async"
    />
  );
}

// Keep QueryClient stable
const queryClient = new QueryClient();

const LINEA_CHAIN_ID = 59144;
const NATIVE = "0x0000000000000000000000000000000000000000";
const DTC = "0xEb1fD1dBB8aDDA4fa2b5A5C4bcE34F6F20d125D2";

// External CTA only (not Relay)
const FORCED_LINEA_SWAP_URL =
  "https://app.wowmax.exchange/swap/59144/0x0000000000000000000000000000000000000000/0xeb1fd1dbb8adda4fa2b5a5c4bce34f6f20d125d2";

const ETH_LOGO =
  "https://cdn.jsdelivr.net/gh/trustwallet/assets@master/blockchains/ethereum/info/logo.png";
const DTC_LOGO =
  "https://cdn.jsdelivr.net/gh/DonaldToad/dtc-assets@main/dtc-32.svg";

type RelayCurrency = {
  chainId: number;
  address: string;
  symbol: string;
  name: string;
  decimals: number;
  vmType?: string;
  logoURI?: string;
  metadata?: {
    logoURI?: string;
    verified?: boolean;
    isNative?: boolean;
  };
};

function withLogo(
  c: RelayCurrency,
  logoURI: string,
  extra?: Partial<RelayCurrency>
): RelayCurrency {
  return {
    ...c,
    ...(extra ?? {}),
    logoURI,
    metadata: {
      ...(c.metadata ?? {}),
      ...(extra?.metadata ?? {}),
      logoURI,
    },
  };
}

/**
 * ✅ Relay wallet adapter for relay-kit-ui v7.x + relay-sdk v5.x
 *
 * RelayKit/SDK expects (at minimum):
 * - address(): Promise<string>
 * - getChainId(): Promise<number>
 * - request({ method, params? }): Promise<any>  (EIP-1193)
 * - handleSendTransactionStep(step): Promise<string | { txHash: string }>
 *
 * We implement all of those using wagmi/viem WalletClient.
 */
function toRelayWallet(walletClient: any) {
  if (!walletClient) return undefined;

  const request = (args: { method: string; params?: any }) =>
    walletClient.request(args);

  const address = async () => walletClient.account?.address;
  const getChainId = async () => walletClient.chain?.id;

  const switchChain = async (chainId: number) => {
    await request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: "0x" + chainId.toString(16) }],
    });
  };

  // Try to extract an EIP-1559 / legacy tx request from Relay step objects
  const pickTxFromStep = (step: any) => {
    // Common patterns we’ve seen in routing SDKs:
    const candidates = [
      step?.tx,
      step?.transaction,
      step?.data?.tx,
      step?.data?.transaction,
      step?.item?.tx,
      step?.item?.transaction,
      step?.items?.[0]?.tx,
      step?.items?.[0]?.transaction,
      step?.transactionRequest,
      step?.data?.transactionRequest,
    ].filter(Boolean);

    for (const tx of candidates) {
      if (tx?.to) return tx;
    }
    return undefined;
  };

  const normalizeTx = async (tx: any) => {
    const from = walletClient.account?.address;
    if (!from) throw new Error("No wallet account available");

    // Relay may pass numbers/BigInt/hex strings; eth_sendTransaction wants hex strings.
    const toHexQty = (v: any) => {
      if (v == null) return undefined;
      if (typeof v === "string") return v; // may already be hex
      try {
        const bi = typeof v === "bigint" ? v : BigInt(v);
        return "0x" + bi.toString(16);
      } catch {
        return undefined;
      }
    };

    const out: any = {
      from,
      to: tx.to,
      data: tx.data ?? tx.calldata ?? undefined,
    };

    // value
    const value = tx.value ?? tx.amount ?? undefined;
    const vHex = toHexQty(value);
    if (vHex) out.value = vHex;

    // gas fields (optional)
    const gas = tx.gas ?? tx.gasLimit ?? undefined;
    const gasHex = toHexQty(gas);
    if (gasHex) out.gas = gasHex;

    const gasPrice = tx.gasPrice ?? undefined;
    const gasPriceHex = toHexQty(gasPrice);
    if (gasPriceHex) out.gasPrice = gasPriceHex;

    const maxFeePerGas = tx.maxFeePerGas ?? undefined;
    const maxFeeHex = toHexQty(maxFeePerGas);
    if (maxFeeHex) out.maxFeePerGas = maxFeeHex;

    const maxPriorityFeePerGas = tx.maxPriorityFeePerGas ?? undefined;
    const maxPrioHex = toHexQty(maxPriorityFeePerGas);
    if (maxPrioHex) out.maxPriorityFeePerGas = maxPrioHex;

    // Some SDKs pass chainId in the tx; keep if present
    if (tx.chainId != null) out.chainId = toHexQty(tx.chainId) ?? tx.chainId;

    return out;
  };

  const handleSendTransactionStep = async (step: any) => {
    const tx = pickTxFromStep(step);
    if (!tx) {
      throw new Error("Relay step missing transaction data");
    }

    // If step wants a chain switch, try it
    const wantedChainId =
      tx.chainId ?? step?.chainId ?? step?.data?.chainId ?? undefined;

    const current = await getChainId();
    if (wantedChainId && Number(wantedChainId) !== Number(current)) {
      await switchChain(Number(wantedChainId));
    }

    const reqTx = await normalizeTx(tx);

    // Send via EIP-1193
    const txHash = await request({
      method: "eth_sendTransaction",
      params: [reqTx],
    });

    // Relay SDK usually accepts either string or { txHash }
    return txHash;
  };

  return {
    // Required by RelayKit UI / SDK
    address,
    getChainId,
    request,
    handleSendTransactionStep,

    // Helpful extras
    switchChain,
    getProvider: () => (globalThis as any).ethereum,
  };
}

export default function SwapPage() {
  const { isConnected, chainId, address: wagmiAddress } = useAccount();
  const { connect, connectors } = useConnect();
  const { data: walletClient } = useWalletClient();

  // Prevent hydration mismatch in the debug line
  const [mounted, setMounted] = useState(false);
  useEffect(() => setMounted(true), []);

  // Init Relay client once (client-side)
  useEffect(() => {
    const g = globalThis as any;
    if (g.__RELAY_CLIENT_READY__) return;
    g.__RELAY_CLIENT_READY__ = true;

    try {
      createClient({
        baseApiUrl: MAINNET_RELAY_API,
        source: "donaldtoad.com",
        chains: [
          convertViemChainToRelayChain(mainnet),
          convertViemChainToRelayChain(linea),
          convertViemChainToRelayChain(base),
          convertViemChainToRelayChain(arbitrum),
          convertViemChainToRelayChain(optimism),
        ],
      } as any);
    } catch (e) {
      console.warn("Relay createClient init failed:", e);
    }
  }, []);

  const relayChains = useMemo(
    () => [
      convertViemChainToRelayChain(mainnet),
      convertViemChainToRelayChain(linea),
      convertViemChainToRelayChain(base),
      convertViemChainToRelayChain(arbitrum),
      convertViemChainToRelayChain(optimism),
    ],
    []
  );

  const relayWallet = useMemo(() => toRelayWallet(walletClient), [walletClient]);

  // Defaults: ETH (Linea) -> DTC (Linea)
  const [fromToken, setFromToken] = useState<RelayCurrency>(() =>
    withLogo(
      {
        chainId: LINEA_CHAIN_ID,
        address: NATIVE,
        decimals: 18,
        name: "Ether",
        symbol: "ETH",
        vmType: "evm",
        metadata: { isNative: true },
      },
      ETH_LOGO
    )
  );

  const [toToken, setToToken] = useState<RelayCurrency>(() =>
    withLogo(
      {
        chainId: LINEA_CHAIN_ID,
        address: DTC,
        decimals: 18,
        name: "Donald Toad Coin",
        symbol: "DTC",
        vmType: "evm",
      },
      DTC_LOGO
    )
  );

  const onConnectWallet = () => {
    if (isConnected) return;
    const first = connectors?.[0];
    if (first) connect({ connector: first, chainId: LINEA_CHAIN_ID });
  };

  return (
    <main className="min-h-screen bg-neutral-950 text-neutral-50">
      <TopNav />

      <section className="mx-auto w-full max-w-5xl px-4 py-10">
        <div className="rounded-3xl border border-neutral-800 bg-neutral-900/30 p-6">
          <div className="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
            <div>
              <h1 className="text-2xl font-bold">Swap</h1>
              <p className="mt-2 text-neutral-300">
                Default: <b>ETH (Linea)</b> → <b>DTC (Linea)</b>. You can switch
                to any chain/token.
              </p>

              <div
                className="mt-2 text-xs text-neutral-400 break-all"
                suppressHydrationWarning
              >
                Wallet:{" "}
                {mounted ? (isConnected ? "connected" : "not connected") : "—"} •
                chainId: {mounted ? chainId ?? "—" : "—"} • address:{" "}
                {mounted ? wagmiAddress ?? "—" : "—"} • walletClient:{" "}
                {mounted ? (walletClient ? "ok" : "—") : "—"}
              </div>
            </div>

            <div className="text-sm text-neutral-400">
              Primary:{" "}
              <span className="text-neutral-100">{PRIMARY_CHAIN.name}</span>
            </div>
          </div>

          {/* Relay widget */}
          <div className="mt-6 flex justify-center">
            <div className="w-full max-w-[440px] rounded-3xl border border-neutral-800 bg-neutral-950 p-4">
              <QueryClientProvider client={queryClient}>
                <RelayKitProviderNoSSR
                  options={{
                    appName: "Lilypad Leap",
                    chains: relayChains,
                    baseApiUrl: MAINNET_RELAY_API,
                    themeScheme: "dark",
                  }}
                >
                  <SwapWidgetNoSSR
                    supportedWalletVMs={["evm"]}
                    wallet={relayWallet as any}
                    onConnectWallet={onConnectWallet}
                    fromToken={fromToken as any}
                    setFromToken={setFromToken as any}
                    toToken={toToken as any}
                    setToToken={setToToken as any}
                    disableInputAutoFocus
                    onRouteError={(e: any) =>
                      console.error("Relay route error:", e)
                    }
                    onSwapError={(e: any) =>
                      console.error("Relay swap error:", e)
                    }
                  />
                </RelayKitProviderNoSSR>
              </QueryClientProvider>

              <div className="mt-3 text-[11px] text-neutral-500 break-all">
                Default DTC (Linea): {DTC}
              </div>

              <div className="mt-3 rounded-xl border border-neutral-800 bg-neutral-950 p-3 text-xs text-neutral-400">
                If swaps fail, check you don’t have multiple wallet extensions
                fighting over the injected provider (MetaMask + another wallet).
              </div>
            </div>
          </div>

          {/* Chain cards */}
          <div className="mt-8 grid gap-3">
            {CHAIN_LIST.map((c) => {
              const isBaseCard = c.chainId === 8453 || c.key === "base";
              const isLineaCard = c.chainId === 59144 || c.key === "linea";

              const displayStatus = isBaseCard ? "SOON" : c.statusTag;
              const swapHref = isLineaCard ? FORCED_LINEA_SWAP_URL : c.swapUrl;
              const swapDisabled = isBaseCard ? true : !(c.enabled && swapHref);

              return (
                <div
                  key={c.key}
                  className="rounded-2xl border border-neutral-800 bg-neutral-950 p-4"
                >
                  <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                      <div className="flex items-center gap-3">
                        <ChainIcon chainKey={c.key} alt={`${c.name} icon`} />
                        <div className="flex items-center gap-2">
                          <div className="text-lg font-semibold">{c.name}</div>

                          <span
                            className={
                              displayStatus === "LIVE"
                                ? "rounded-full bg-emerald-500/10 px-2 py-0.5 text-xs font-medium text-emerald-300 ring-1 ring-emerald-500/20"
                                : displayStatus === "SOON"
                                ? "rounded-full bg-orange-500/10 px-2 py-0.5 text-xs font-medium text-orange-300 ring-1 ring-orange-500/20"
                                : "rounded-full bg-amber-500/10 px-2 py-0.5 text-xs font-medium text-amber-300 ring-1 ring-amber-500/20"
                            }
                          >
                            {displayStatus}
                          </span>

                          {c.isPrimary ? (
                            <span className="rounded-full bg-neutral-800/60 px-2 py-0.5 text-xs text-neutral-200 ring-1 ring-neutral-700">
                              PRIMARY
                            </span>
                          ) : null}
                        </div>
                      </div>

                      <div className="mt-3 text-sm text-neutral-200">
                        {c.swapLabel}
                      </div>
                      <div className="mt-2 text-sm text-neutral-300">
                        {c.note}
                      </div>

                      <div className="mt-3 text-xs text-neutral-500">
                        Chain ID: {c.chainId}
                        {c.explorerBaseUrl ? (
                          <>
                            {" "}
                            • Explorer:{" "}
                            <span className="text-neutral-300">
                              {c.explorerBaseUrl.replace("https://", "")}
                            </span>
                          </>
                        ) : null}
                      </div>

                      {isBaseCard ? (
                        <div className="mt-3 rounded-xl border border-orange-500/20 bg-orange-500/10 p-3 text-xs text-orange-200">
                          <b>Base swap is coming soon.</b> DTC on Base will be
                          announced from official Donald Toad Coin accounts only
                          — beware of impersonators and fake token contracts.
                        </div>
                      ) : null}
                    </div>

                    <div className="flex gap-2">
                      {!swapDisabled ? (
                        <a
                          href={swapHref}
                          target="_blank"
                          rel="noreferrer"
                          className="rounded-xl bg-emerald-500 px-4 py-2 text-center text-sm font-semibold text-neutral-950 hover:bg-emerald-400"
                        >
                          Open Swap
                        </a>
                      ) : (
                        <button
                          disabled
                          className="cursor-not-allowed rounded-xl border border-orange-500/25 bg-orange-500/10 px-4 py-2 text-sm font-semibold text-orange-200"
                          title={
                            isBaseCard
                              ? "Base swap coming soon"
                              : "Swap unavailable"
                          }
                        >
                          SOON
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <div className="mt-6 rounded-2xl border border-neutral-800 bg-neutral-950 p-4 text-sm text-neutral-300">
            <b>Note:</b> Relay widget is full aggregator mode; defaults are ETH →
            DTC on Linea.
          </div>
        </div>
      </section>
    </main>
  );
}
